#!/usr/bin/env python3

import os
import shutil
import subprocess
import argparse

# Hardcoded values
SRC_DIR = "OPT_V0"
DEST_BASE_DIR = "OPT_V"
FILES_TO_COPY = ["INCAR", "CONTCAR", "POTCAR", "vasp.job", "KPOINTS"]
NUM_FOLDERS = 4
SCALING_INCREMENT = 0.002
NUM_JOBS = 20
PHONOPY_SCRIPT = "/home/nipj5103/scripts/phonopy_script.sh"
FILES_VASP_DIR = "../../../files_VASP"
E_V_DAT_FILENAME = "e-v.dat"

def modify_poscar(src_file, dest_file, increment):
    with open(src_file, 'r') as src, open(dest_file, 'w') as dest:
        lines = src.readlines()
        if len(lines) > 1:
            lines[1] = str(float(lines[1].strip()) + increment) + '\n'
        dest.writelines(lines)

def modify_incar(src_file, dest_file):
    with open(src_file, 'r') as src, open(dest_file, 'w') as dest:
        for line in src:
            if line.startswith('ISIF = 3'):
                dest.write('ISIF = 2 #relaxation of the ion positions\n')
            else:
                dest.write(line)

def create_directories():
    for i in range(1, NUM_FOLDERS + 1):
        for sign in ('+', '-'):
            new_dir = f"{DEST_BASE_DIR}{sign}{i}"
            os.makedirs(new_dir, exist_ok=True)
            for file in FILES_TO_COPY:
                src_file = os.path.join(SRC_DIR, file)
                if file == "CONTCAR":
                    dest_file = os.path.join(new_dir, "POSCAR")
                    increment = i * SCALING_INCREMENT if sign == '+' else -i * SCALING_INCREMENT
                    modify_poscar(src_file, dest_file, increment)
                elif file == "INCAR":
                    dest_file = os.path.join(new_dir, file)
                    modify_incar(src_file, dest_file)
                else:
                    dest_file = os.path.join(new_dir, file)
                    shutil.copy(src_file, dest_file)

def get_directory_list(include_opt_v0=False):
    directories = []
    for i in range(NUM_FOLDERS, 0, -1):
        directories.append(f"OPT_V-{i}")
    if include_opt_v0:
        directories.append("OPT_V0")
    for i in range(1, NUM_FOLDERS + 1):
        directories.append(f"OPT_V+{i}")
    return directories

def submit_jobs():
    directories = get_directory_list()
    for dir in directories:
        if os.path.isdir(dir):
            os.chdir(dir)
            print(f" This is volume {dir}")
            shutil.copy('../vasp.job', '.')
            subprocess.run(['sbatch', '-J', dir, 'vasp.job'])
            os.chdir('..')

def check_jobs():
    directories = get_directory_list()
    for dir in directories:
        if os.path.isdir(dir):
            print(f" This is job number {dir}")
            os.chdir(dir)
            subprocess.run(['tail', 'OUTCAR'])
            subprocess.run(['grep', 'free energy', 'OUTCAR'])
            subprocess.run(['grep', 'reached', 'OUTCAR'])
            latest = sorted([f for f in os.listdir() if f.startswith('slurm-')], reverse=True)[0]
            with open(latest, 'r') as f:
                print(f.read())
            os.chdir('..')

def run_phonopy():
    directories = get_directory_list()
    for dir in directories:
        if os.path.isdir(dir):
            print(f"\n This is volume {dir}\n")
            os.chdir(dir)
            os.makedirs('phonopy', exist_ok=True)
            os.chdir('phonopy')
            subprocess.run([PHONOPY_SCRIPT], check=True)
            os.chdir('../..')

def create_ev_dat():
    directories = get_directory_list(include_opt_v0=True)
    with open(E_V_DAT_FILENAME, 'w') as outfile:
        outfile.write("#   cell volume   energy of cell other than phonon\n")
        for dir in directories:
            outcar_path = os.path.join(dir, 'OUTCAR')
            if os.path.isfile(outcar_path):
                with open(outcar_path, 'r') as f:
                    lines = f.readlines()
                    volume = None
                    energy = None
                    for line in lines:
                        if "volume of cell" in line:
                            volume = float(line.split()[-1])
                        if "free  energy   TOTEN" in line:
                            energy = float(line.split()[-2])
                    if volume is not None and energy is not None:
                        outfile.write(f"{volume}           {energy}\n")
                    else:
                        print(f"Warning: Volume or energy not found in {outcar_path}")

def create_tp_links():
    directories = get_directory_list(include_opt_v0=True)
    os.makedirs("thermal_properties", exist_ok=True)
    index = 1
    for dir in directories:
        thermal_properties_path = os.path.abspath(os.path.join(dir, 'phonopy', 'thermal_properties.yaml'))
        if os.path.isfile(thermal_properties_path):
            link_name = os.path.abspath(f"thermal_properties/thermal_properties-{index:03}.yaml")
            try:
                os.symlink(thermal_properties_path, link_name)
                print(f"Created symlink: {link_name} -> {thermal_properties_path}")
            except OSError as e:
                print(f"Failed to create symlink: {link_name} -> {thermal_properties_path}")
                print(f"Error: {e}")
            index += 1

def submit_phonopy_jobs():
    directories = get_directory_list()
    for dir in directories:
        if os.path.isdir(dir):
            print(f"\n This is volume {dir}\n")
            os.chdir(dir)
            os.chdir('phonopy')
            for i in range(NUM_JOBS):
                job_dir = str(i)
                if os.path.isdir(job_dir):
                    os.chdir(job_dir)
                    shutil.copy('../../../files_VASP/vasp.job', '.')
                    shutil.copy('../../../files_VASP/INCAR', '.')
                    print(f"This is job number {i}")
                    if MODEP == "direct":
                        subprocess.run(['sbatch', '-J', f"{dir}{i}", 'vasp.job'])
                    elif MODEP == "steps":
                        subprocess.run(['~/scripts/crear_incar123', 'INCAR'])
                        shutil.copy(f'INCAR.{step}', 'INCAR')
                        subprocess.run(['sbatch', '-J', f"{dir}_s{step}-{i}", 'vasp.job'])
                    elif MODEP == "resubmit":
                        resubmit_job = False
                        # Check OUTCAR for "aborting loop because EDIFF is reached"
                        if not os.path.isfile('OUTCAR') or "aborting loop because EDIFF is reached" not in open('OUTCAR').read():
                            resubmit_job = True
                        # Check latest slurm file for "error"
                        slurm_files = [f for f in os.listdir() if f.startswith('slurm-')]
                        if slurm_files:
                            latest_slurm = max(slurm_files, key=os.path.getctime)
                            if "error" in open(latest_slurm).read():
                                resubmit_job = True
                        if resubmit_job:
                            subprocess.run(['sbatch', '-J', f"{dir}{i}", 'vasp.job'])
                    os.chdir('..')
            os.chdir('../..')

def main():
    global MODEP

    parser = argparse.ArgumentParser(description="Script to manage VASP jobs.")
    
    # Define the argument 'mode' with choices
    parser.add_argument('mode', choices=['create', 'submit', 'check', 'phonopy', 'create_ev_dat', 'create_tp_links', 'submit_phonopy_jobs'],
                        help="Mode of operation")
    parser.add_argument('--modep', type=str, choices=['direct', 'steps', 'resubmit'], default='direct',
                        help="Phonopy submission mode")

    # Parse the arguments
    args = parser.parse_args()
    MODEP = args.modep

    print(f"Running in mode: {args.mode}")
    print(f"Phonopy submission mode: {args.modep}")

    if args.mode == 'create':
        create_directories()
    elif args.mode == 'submit':
        submit_jobs()
    elif args.mode == 'check':
        check_jobs()
    elif args.mode == 'phonopy':
        run_phonopy()
    elif args.mode == 'create_ev_dat':
        create_ev_dat()
    elif args.mode == 'create_tp_links':
        create_tp_links()
    elif args.mode == 'submit_phonopy_jobs':
        submit_phonopy_jobs()

if __name__ == "__main__":
    main()

